<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>title</title>
</head>

<body>
    <div id="target"></div>
    <script>
        const targetDiv = document.querySelector('#target');

        function splitStream(splitOn) {
            let buffer = '';

            return new TransformStream({
                transform(chunk, controller) {
                    buffer += chunk;
                    const parts = buffer.split(splitOn);
                    parts.slice(0, -1).forEach(part => controller.enqueue(part));
                    buffer = parts[parts.length - 1];
                },
                flush(controller) {
                    if (buffer) controller.enqueue(buffer);
                }
            });
        }

        function parseJSON() {
            return new TransformStream({
                transform(chunk, controller) {
                    controller.enqueue(JSON.parse(chunk));
                }
            });
        }

        function test(reader){
            reader.read().then(
                ({ value, done }) => {
                    if (done) {
                        console.log("The stream was already closed!");
                    } else {
                        targetDiv.innerHTML += value + '\n';
                        test(reader);
                    }
                },
                e => console.error("The stream became errored and cannot be read from!", e)
            );


        }

        async function fetchDirectlyIntoDOM2() {
            const response = await fetch('http://localhost:3000/request');

            const comments = response.body
                // // From bytes to text:
                .pipeThrough(new TextDecoderStream());
            // // Buffer until newlines:
            // .pipeThrough(splitStream('\n'))
            // // Parse chunks as JSON:
            // .pipeThrough(parseJSON());

            
            let reader = comments.getReader();

            test(reader);

            //console.log(await comments);

            //let reader = comments.getReader();

            // comments.read().then(result => {
            //     // result.value will be a string
            //     targetDiv.innerHTML += result.value + '\n';
            // });

            // reader.read().then(
            //     ({ value, done }) => {
            //         if (done) {
            //             console.log("The stream was already closed!");
            //         } else {
            //             targetDiv.innerHTML += value + '\n';
            //         }
            //     },
            //     e => console.error("The stream became errored and cannot be read from!", e)
            // );
        }

        fetchDirectlyIntoDOM2();
    </script>
</body>

</html>